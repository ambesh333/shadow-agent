generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Network {
  MAINNET
  DEVNET
}

enum Token {
  NATIVE
  USDC
  USDT
}

// Merchant: Data providers who receive payments
model Merchant {
  id            String        @id @default(uuid())
  walletAddress String        @unique
  displayName   String?
  lastLogin     DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  transactions  Transaction[]
  resources     Resource[]
}

// Resource: Media assets (images stored as base64, videos as URLs)
model Resource {
  id          String   @id @default(uuid())
  merchantId  String
  merchant    Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  
  title       String
  description String?
  type        String   // IMAGE, VIDEO, LINK
  price       Float    @default(0)
  
  // Multi-network & Multi-token support
  network     Network  @default(MAINNET)
  token       Token    @default(NATIVE)
  mintAddress String?  // Optional for SPL tokens

  // For IMAGE type: base64 encoded data
  imageData   String?  @db.Text
  
  // For VIDEO/LINK type: external URL
  url         String?
  
  // Auto-approval timeout for escrow
  autoApprovalMinutes Int @default(60)
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  transactions Transaction[]

  @@index([merchantId])
}

// AuthChallenge: Short-lived nonces for SIWS
model AuthChallenge {
  id            String   @id @default(uuid())
  walletAddress String
  nonce         String   @unique
  expiresAt     DateTime
  used          Boolean  @default(false)
  createdAt     DateTime @default(now())

  @@index([walletAddress])
}

// Transaction: Escrow records
model Transaction {
  id                     String    @id @default(uuid())
  merchantId             String
  merchant               Merchant  @relation(fields: [merchantId], references: [id])
  resourceId             String?
  resource               Resource? @relation(fields: [resourceId], references: [id])
  agentId                String
  amount                 Float
  
  network                Network   @default(MAINNET)
  token                  Token     @default(NATIVE)
  
  status                 String    // PENDING, DELIVERED, SETTLED, REFUND_REQUESTED, REFUNDED
  dataPayload            String?
  expiryAt               DateTime
  
  // Escrow enhancements
  receiptCode            String    @unique @default(uuid())
  autoSettleAt           DateTime?
  encryptedDisputeReason String?
  merchantPubKey         String?   // For dispute message encryption
  
  // Storage for Settlement
  paymentHeader          String?   @db.Text

  // AI Dispute Resolution
  aiDecision             String?   // AI_VALID, AI_INVALID, PENDING_REVIEW
  aiReasoning            String?   @db.Text
  aiConfidence           Int?      // 0-100
  merchantExplanation    String?   @db.Text
  aiAnalyzedAt           DateTime?

  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  @@index([merchantId])
  @@index([resourceId])
  @@index([autoSettleAt])
}
